onderhold: finally! pytest tests/test_cli.py --apps excel -v leads to
=========================================================================== 27 passed in 84.59s (0:01:24) ============================================================================
( there is still
tests\test_cli.py ...................Windows fatal exception: code 0x80010108

Current thread 0x0000483c (most recent call first):
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\dynamic.py", line 81 in \_GetGoodDispatch
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\dynamic.py", line 101 in \_GetGoodDispatchAndUserName
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\_\_init**.py", line 116 in Dispatch
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\tests\cli\helpers.py", line 58 in **enter**
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\tests\cli\helpers.py", line 136 in temp_office_doc
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 923 in call_fixture_func
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 1196 in pytest_fixture_setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 1128 in execute
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 640 in \_get_active_fixturedef
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 549 in getfixturevalue
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 720 in \_fillfixtures
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\python.py", line 1674 in setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 514 in setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 164 in pytest_runtest_setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 246 in <lambda>
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 344 in from_call
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 245 in call_and_report
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 130 in runtestprotocol
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 117 in pytest_runtest_protocol
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 367 in pytest_runtestloop
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 343 in \_main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 289 in wrap_session
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 336 in pytest_cmdline_main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\config\_\_init**.py", line 175 in main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\config\_\_init**.py", line 201 in console_main
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Scripts\pytest.exe\_\_main**.py", line 6 in <module>
File "<frozen runpy>", line 88 in \_run_code
File "<frozen runpy>", line 198 in \_run_module_as_main
Windows fatal exception: code 0x800706ba

Current thread 0x0000483c (most recent call first):
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\dynamic.py", line 81 in \_GetGoodDispatch
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\dynamic.py", line 101 in \_GetGoodDispatchAndUserName
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\_\_init**.py", line 116 in Dispatch
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\tests\cli\helpers.py", line 58 in **enter**
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\tests\cli\helpers.py", line 136 in temp_office_doc
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 923 in call_fixture_func
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 1196 in pytest_fixture_setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 1128 in execute
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 640 in \_get_active_fixturedef
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 549 in getfixturevalue
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 720 in \_fillfixtures
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\python.py", line 1674 in setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 514 in setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 164 in pytest_runtest_setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 246 in <lambda>
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 344 in from_call
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 245 in call_and_report
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 130 in runtestprotocol
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 117 in pytest_runtest_protocol
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 367 in pytest_runtestloop
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 343 in \_main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 289 in wrap_session
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 336 in pytest_cmdline_main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\config\_\_init**.py", line 175 in main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\config\_\_init**.py", line 201 in console_main
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Scripts\pytest.exe\_\_main**.py", line 6 in <module>
File "<frozen runpy>", line 88 in \_run_code
File "<frozen runpy>", line 198 in \_run_module_as_main
.Windows fatal exception: code 0x80010108

Current thread 0x0000483c (most recent call first):
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\dynamic.py", line 81 in \_GetGoodDispatch
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\dynamic.py", line 101 in \_GetGoodDispatchAndUserName
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\win32com\client\_\_init**.py", line 116 in Dispatch
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\tests\cli\helpers.py", line 58 in **enter**
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\tests\cli\helpers.py", line 136 in temp_office_doc
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 923 in call_fixture_func
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 1196 in pytest_fixture_setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 1128 in execute
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 640 in \_get_active_fixturedef
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 549 in getfixturevalue
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\fixtures.py", line 720 in \_fillfixtures
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\python.py", line 1674 in setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 514 in setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 164 in pytest_runtest_setup
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 246 in <lambda>
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 344 in from_call
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 245 in call_and_report
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 130 in runtestprotocol
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\runner.py", line 117 in pytest_runtest_protocol
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 367 in pytest_runtestloop
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 343 in \_main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 289 in wrap_session
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\main.py", line 336 in pytest_cmdline_main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_callers.py", line 121 in \_multicall
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_manager.py", line 120 in \_hookexec
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages\pluggy_hooks.py", line 512 in **call**
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\config\_\_init**.py", line 175 in main
File "c:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Lib\site-packages_pytest\config\_\_init**.py", line 201 in console_main
File "C:\_daten.lokal_workarea\git.repos\onderhold\vba-editRD\.venv\Scripts\pytest.exe\_\_main**.py", line 6 in <module>
File "<frozen runpy>", line 88 in \_run_code
File "<frozen runpy>", line 198 in \_run_module_as_main

though)

GitHub Copilot: GitHub Copilot

Great result on the 27 passed. The remaining crashes are COM flakiness: 0x80010108 (object disconnected) and 0x800706ba (RPC server unavailable). They typically occur when Office COM servers are closing while references still exist, or when creating a new COM instance immediately after a quit.

Suggested branch: fix/windows-com-stability

What to do

- Initialize COM for tests marked with @pytest.mark.com.
- Add a robust Dispatch helper with retries.
- Make the Office app context manager teardown defensive (close docs, quit app, drop refs, uninitialize COM).
- Optionally skip COM tests if Office isnâ€™t available.

Add COM init for @com tests

```python
# ...existing code...
import pytest

try:
    import pythoncom  # pywin32
except Exception:
    pythoncom = None

@pytest.fixture(autouse=True)
def _com_init_for_marked_tests(request):
    """Ensure COM is initialized for tests marked with @pytest.mark.com."""
    if pythoncom is None:
        yield
        return
    if request.node.get_closest_marker("com"):
        pythoncom.CoInitialize()
        try:
            yield
        finally:
            try:
                pythoncom.CoUninitialize()
            except Exception:
                pass
    else:
        yield
# ...existing code...
```

Harden COM startup and teardown in helpers

```python
# ...existing code...
import time
import contextlib

import pytest
import win32com.client as win32

try:
    import pythoncom
except Exception:
    pythoncom = None

def _ensure_com_initialized():
    if pythoncom:
        try:
            pythoncom.CoInitialize()
        except Exception:
            # Already initialized in this thread
            pass

def _com_uninitialize():
    if pythoncom:
        with contextlib.suppress(Exception):
            pythoncom.CoUninitialize()

def _dispatch_with_retries(prog_id: str, retries: int = 3, delay: float = 0.6):
    last = None
    for i in range(retries):
        try:
            _ensure_com_initialized()
            # EnsureDispatch generates early-bound wrappers; falls back if not generated
            return win32.gencache.EnsureDispatch(prog_id)
        except Exception as e:
            last = e
            time.sleep(delay)
    raise last

class OfficeApp:
    """Context manager to start/stop an Office application safely."""
    def __init__(self, prog_id: str):
        self.prog_id = prog_id
        self.app = None

    def __enter__(self):
        try:
            self.app = _dispatch_with_retries(self.prog_id)
        except Exception as e:
            pytest.skip(f"COM '{self.prog_id}' unavailable: {e}")
        # Best-practice flags
        with contextlib.suppress(Exception):
            self.app.Visible = False
        with contextlib.suppress(Exception):
            self.app.DisplayAlerts = False
        return self.app

    def __exit__(self, exc_type, exc, tb):
        # Try to close docs/workbooks without raising
        with contextlib.suppress(Exception):
            if hasattr(self.app, "Workbooks"):
                for wb in list(self.app.Workbooks):
                    with contextlib.suppress(Exception):
                        wb.Close(SaveChanges=False)
            if hasattr(self.app, "Documents"):
                for doc in list(self.app.Documents):
                    with contextlib.suppress(Exception):
                        doc.Close(SaveChanges=False)

        # Quit app and drop references
        with contextlib.suppress(Exception):
            self.app.Quit()
        self.app = None

        # Let COM clean up
        _com_uninitialize()
        return False
# ...existing code...
```

Usage in temp_office_doc (example)

```python
# ...existing code...
# Example for Excel; adapt for Word/Access if present in your file
def _excel_app():
    return OfficeApp("Excel.Application")

@pytest.fixture
def temp_office_doc(vba_app, tmp_path):
    # Create a temp document via COM only when integration/COM tests run
    if vba_app != "excel":
        pytest.skip("Only implemented for Excel in this fixture example")
    with _excel_app() as xl:
        path = tmp_path / "test_doc.xlsm"
        # ... create workbook, save to 'path' ...
        return path
# ...existing code...
```

Operational tips

- To avoid COM in routine runs: pytest -m "not com" -v
- To debug one failing COM test: pytest tests/cli/test_config.py::TestCLIConfig::test_config_file_with_real_document --apps excel -v -s
- If Excel stays running between tests, add small sleeps (0.5s) after Quit or use a single session-scoped app to reduce churn.

Why this helps

- 0x800706ba (RPC server unavailable) and 0x80010108 (disconnected) are reduced by initializing COM explicitly, retrying Dispatch, and making teardown tolerant and ordered (close docs before Quit, drop refs, uninitialize).

If crashes persist

- Ensure no background thread accesses COM objects after Quit.
- Run tests serially (default) and avoid --maxfail or xdist.
- Consider a session-scoped Excel instance shared by tests to minimize process churn, if acceptable to your suite.
