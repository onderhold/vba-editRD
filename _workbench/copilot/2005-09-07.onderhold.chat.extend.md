onderhold: @workspace Now, I will extend the code with a new option to allow for Rubberduck folder annotations to be used as source/target folder specification. And I will also replace watchgod by it's successor watchfiles.

Github Copilot: Looking at your workspace, I can see you're working on the `vba-edit` project and specifically focusing on the `create_cli_parser` function in excel_vba.py.

Based on your request to add Rubberduck folder annotations support and replace watchgod with watchfiles, here are the changes needed:

## 1. Add Rubberduck folder support to CLI parser

````python
def create_cli_parser() -> argparse.ArgumentParser:
    """Create the command-line interface parser."""
    # ...existing code...

    # Create parsers for each command with common arguments
    common_args = {
        "file": (["--file", "-f"], {"help": "Path to Excel workbook (optional, defaults to active workbook)"}),
        "vba_directory": (
            ["--vba-directory"],
            {"help": "Directory to export VBA files to (optional, defaults to current directory)"},
        ),
        "verbose": (["--verbose", "-v"], {"action": "store_true", "help": "Enable verbose logging output"}),
        "logfile": (
            ["--logfile", "-l"],
            {
                "nargs": "?",
                "const": "vba_edit.log",
                "help": "Enable logging to file. Optional path can be specified (default: vba_edit.log)",
            },
        ),
        "xlwings": (
            ["--xlwings", "-x"],
            {
                "action": "store_true",
                "help": "Use wrapper for xlwings vba edit|import|export commands",
            },
        ),
        "rubberduck_folders": (
            ["--rubberduck-folders", "-r"],
            {
                "action": "store_true",
                "help": "Enable Rubberduck @Folder annotations for organizing VBA modules in subdirectories",
            },
        ),
    }

    # Edit command
    edit_parser = subparsers.add_parser("edit", help="Edit VBA content in Excel workbook")
    # ...existing encoding and save-headers code...

    # Import command
    import_parser = subparsers.add_parser("import", help="Import VBA content into Excel workbook")
    # ...existing code...

    # Export command
    export_parser = subparsers.add_parser("export", help="Export VBA content from Excel workbook")
    # ...existing code...

    # Check command (no changes needed)
    # ...existing code...

    # Add common arguments to all subparsers (except check command)
    subparser_list = [edit_parser, import_parser, export_parser]
    for subparser in subparser_list:
        for arg_name, (arg_flags, arg_kwargs) in common_args.items():
            subparser.add_argument(*arg_flags, **arg_kwargs)

    return parser
````

## 2. Update handler initialization to pass Rubberduck folders option

````python
def handle_excel_vba_command(args: argparse.Namespace) -> None:
    """Handle the excel-vba command execution."""
    try:
        # ...existing logging and path resolution code...

        # Create handler instance
        try:
            handler = ExcelVBAHandler(
                doc_path=str(doc_path),
                vba_dir=str(vba_dir),
                encoding=encoding,
                verbose=getattr(args, "verbose", False),
                save_headers=getattr(args, "save_headers", False),
                use_rubberduck_folders=getattr(args, "rubberduck_folders", False),
            )
        except VBAError as e:
            logger.error(f"Failed to initialize Excel VBA handler: {str(e)}")
            sys.exit(1)

        # ...rest of existing code...
````

## 3. Replace watchgod with watchfiles in requirements

````toml
dependencies = ["chardet", "pywin32 >= 224;platform_system=='Windows'" ,"watchfiles"]
````

## 4. Update office_vba.py to use watchfiles

````python
# Third-party imports
import win32com.client
from watchfiles import watch, Change

# ...existing code...

class OfficeVBAHandler(ABC):
    # ...existing code...
    
    def watch_changes(self) -> None:
        """Watch for changes in VBA files and update the document."""
        try:
            logger.info(f"Watching for changes in {self.vba_dir}...")
            last_check_time = time.time()
            check_interval = 30  # Check connection every 30 seconds

            # Setup file watcher with recursive support if Rubberduck folders are enabled
            watch_paths = [self.vba_dir]
            
            # Watch for .bas, .cls, .frm files
            for changes in watch(*watch_paths, recursive=self.use_rubberduck_folders):
                try:
                    # Check connection periodically
                    current_time = time.time()
                    if current_time - last_check_time >= check_interval:
                        if not self.is_document_open():
                            raise DocumentClosedError(self.document_type)
                        last_check_time = current_time
                        logger.debug("Connection check passed")

                    if changes:
                        logger.debug(f"Watchfiles detected changes: {changes}")

                    for change_type, path_str in changes:
                        try:
                            path = Path(path_str)
                            
                            # Only process VBA files
                            if path.suffix.lower() not in {'.bas', '.cls', '.frm'}:
                                continue
                                
                            if change_type == Change.deleted:
                                # Handle deleted files
                                logger.info(f"Detected deletion of {path.name}")
                                if not self.is_document_open():
                                    raise DocumentClosedError(self.document_type)

                                vba_project = self.get_vba_project()
                                components = vba_project.VBComponents
                                try:
                                    component = components(path.stem)
                                    components.Remove(component)
                                    logger.info(f"Removed component: {path.stem}")
                                    self.doc.Save()
                                except Exception:
                                    logger.debug(f"Component {path.stem} already removed or not found")

                            elif change_type in (Change.added, Change.modified):
                                # Handle both added and modified files the same way
                                action = "addition" if change_type == Change.added else "modification"
                                logger.debug(f"Processing {action} in {path}")
                                self.import_single_file(path)

                        except (DocumentClosedError, RPCError) as e:
                            raise e
                        except Exception as e:
                            logger.warning(f"Error handling changes (will retry): {str(e)}")
                            continue

                except (DocumentClosedError, RPCError) as error:
                    raise error
                except Exception as error:
                    logger.warning(f"Error in watch loop (will continue): {str(error)}")

        except KeyboardInterrupt:
            logger.info("\nStopping VBA editor...")
        except (DocumentClosedError, RPCError) as error:
            raise error
        finally:
            logger.info("VBA editor stopped.")
````

## 5. Add tests for the new functionality

````python
"""Tests for Excel VBA CLI functionality."""

import pytest
import tempfile
from pathlib import Path
from unittest.mock import Mock, patch

from vba_edit.excel_vba import create_cli_parser, handle_excel_vba_command


def test_create_cli_parser_rubberduck_option():
    """Test that the CLI parser includes Rubberduck folders option."""
    parser = create_cli_parser()
    
    # Test edit command with rubberduck folders
    args = parser.parse_args(['edit', '--rubberduck-folders'])
    assert args.rubberduck_folders is True
    
    # Test export command with rubberduck folders
    args = parser.parse_args(['export', '--rubberduck-folders'])
    assert args.rubberduck_folders is True
    
    # Test import command with rubberduck folders
    args = parser.parse_args(['import', '--rubberduck-folders'])
    assert args.rubberduck_folders is True
    
    # Test that check command doesn't have rubberduck option
    args = parser.parse_args(['check'])
    assert not hasattr(args, 'rubberduck_folders')


@patch('vba_edit.excel_vba.ExcelVBAHandler')
@patch('vba_edit.excel_vba.get_document_paths')
@patch('vba_edit.excel_vba.setup_logging')
def test_rubberduck_folders_passed_to_handler(mock_logging, mock_get_paths, mock_handler):
    """Test that rubberduck_folders option is passed to the handler."""
    with tempfile.TemporaryDirectory() as tmpdir:
        tmp_path = Path(tmpdir)
        doc_path = tmp_path / "test.xlsm"
        doc_path.touch()
        
        # Mock the path resolution
        mock_get_paths.return_value = (doc_path, tmp_path)
        
        # Create mock handler instance
        mock_handler_instance = Mock()
        mock_handler.return_value = mock_handler_instance
        
        # Create args with rubberduck_folders enabled
        parser = create_cli_parser()
        args = parser.parse_args(['export', '--rubberduck-folders', '--file', str(doc_path)])
        
        # Handle the command
        handle_excel_vba_command(args)
        
        # Verify handler was called with use_rubberduck_folders=True
        mock_handler.assert_called_once()
        call_kwargs = mock_handler.call_args[1]
        assert call_kwargs['use_rubberduck_folders'] is True


def test_watchfiles_integration():
    """Test that watchfiles is properly integrated."""
    try:
        from watchfiles import watch, Change
        assert True, "watchfiles imported successfully"
    except ImportError:
        pytest.fail("watchfiles not available - please update dependencies")
````

## 6. Update ExcelVBAHandler constructor (if needed)

You'll need to ensure that `ExcelVBAHandler` accepts the `use_rubberduck_folders` parameter. Based on the existing code, it likely inherits from `OfficeVBAHandler` which should already support this.

These changes will:

1. Add a `--rubberduck-folders` / `-r` option to all VBA commands (edit, import, export)
2. Pass this option to the VBA handler to enable Rubberduck folder processing
3. Replace `watchgod` with `watchfiles` for better performance and maintenance
4. Add appropriate tests to ensure the functionality works correctly

The Rubberduck folder support will allow users to organize their VBA modules in subdirectories using `@Folder` annotations, making it easier to manage large VBA projects with many modules.
